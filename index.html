<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Mine Muncher">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#1a0a1a">
  <title>Mine Muncher 3D</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none;-webkit-user-select:none;user-select:none}
    html,body{width:100%;height:100%;overflow:hidden;touch-action:none;font-family:'Press Start 2P',monospace}
    body{background:linear-gradient(180deg,#0a0515 0%,#1a0a2a 40%,#0d0d1a 100%)}
    #root{width:100%;height:100%}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}
    @keyframes glow{0%,100%{box-shadow:0 0 10px #50c878}50%{box-shadow:0 0 25px #50c878,0 0 40px #50c878}}
    @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
    @keyframes wingFlap{0%,100%{transform:rotate(-10deg) scaleY(1)}50%{transform:rotate(10deg) scaleY(0.7)}}
    @keyframes deathFlash{0%,100%{opacity:1}50%{opacity:0.2}}
    @keyframes particleFloat{0%{opacity:0.8;transform:translateY(0)}100%{opacity:0;transform:translateY(-15px)}}
    @keyframes bobUp{0%,100%{transform:translateY(0)}50%{transform:translateY(-3px)}}
    @keyframes spin{0%{transform:rotateY(0deg)}100%{transform:rotateY(360deg)}}
    input{-webkit-user-select:text;user-select:text}
    .sound-btn{font-family:'Press Start 2P',monospace;font-size:12px;padding:12px 24px;border-radius:12px;color:#fff;cursor:pointer;display:flex;align-items:center;gap:10px;margin:6px 0;transition:all 0.2s}
    .sound-btn.on{background:linear-gradient(180deg,#22cc66,#119944);border:4px solid #00ff55;box-shadow:0 0 20px rgba(0,255,100,0.6),inset 0 2px 4px rgba(255,255,255,0.3);animation:glow 1.5s ease-in-out infinite}
    .sound-btn.off{background:linear-gradient(180deg,#cc4444,#992222);border:4px solid #ff4444;box-shadow:0 0 15px rgba(255,50,50,0.5),inset 0 2px 4px rgba(255,255,255,0.2)}
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script>
// ============ UPBEAT MUSIC ENGINE WITH TRUMPET ============
const MusicEngine = {
  ctx: null,
  playing: false,
  loopTimeout: null,
  
  init() {
    if (this.ctx) return true;
    try {
      this.ctx = new (window.AudioContext || window.webkitAudioContext)();
      return true;
    } catch(e) { return false; }
  },
  
  resume() {
    if (this.ctx && this.ctx.state === 'suspended') this.ctx.resume();
  },
  
  notes: {
    C3:130.81,D3:146.83,E3:164.81,F3:174.61,G3:196.00,A3:220.00,B3:246.94,
    C4:261.63,D4:293.66,E4:329.63,F4:349.23,G4:392.00,A4:440.00,B4:493.88,
    C5:523.25,D5:587.33,E5:659.25,F5:698.46,G5:783.99,A5:880.00
  },
  
  // Punchy tone for upbeat feel
  playTone(freq, duration, startTime, type, volume, attack=0.05, release=0.2) {
    if (!this.ctx || !this.playing) return;
    try {
      const osc = this.ctx.createOscillator();
      const gain = this.ctx.createGain();
      
      osc.type = type;
      osc.frequency.value = freq;
      
      const t = this.ctx.currentTime + startTime;
      gain.gain.setValueAtTime(0, t);
      gain.gain.linearRampToValueAtTime(volume, t + attack);
      gain.gain.setValueAtTime(volume * 0.7, t + duration - release);
      gain.gain.exponentialRampToValueAtTime(0.001, t + duration);
      
      osc.connect(gain);
      gain.connect(this.ctx.destination);
      
      osc.start(t);
      osc.stop(t + duration + 0.1);
    } catch(e) {}
  },
  
  // Bright trumpet sound
  playTrumpet(freq, duration, startTime, volume) {
    if (!this.ctx || !this.playing) return;
    try {
      const t = this.ctx.currentTime + startTime;
      
      const osc1 = this.ctx.createOscillator();
      const osc2 = this.ctx.createOscillator();
      const gain = this.ctx.createGain();
      const filter = this.ctx.createBiquadFilter();
      
      filter.type = 'bandpass';
      filter.frequency.value = freq * 2.5;
      filter.Q.value = 3;
      
      osc1.type = 'sawtooth';
      osc1.frequency.value = freq;
      osc2.type = 'square';
      osc2.frequency.value = freq * 2;
      
      const mix1 = this.ctx.createGain();
      mix1.gain.value = 0.6;
      const mix2 = this.ctx.createGain();
      mix2.gain.value = 0.2;
      
      // Quick punchy attack
      gain.gain.setValueAtTime(0, t);
      gain.gain.linearRampToValueAtTime(volume, t + 0.03);
      gain.gain.setValueAtTime(volume * 0.85, t + 0.08);
      gain.gain.linearRampToValueAtTime(volume * 0.6, t + duration * 0.6);
      gain.gain.exponentialRampToValueAtTime(0.001, t + duration);
      
      osc1.connect(mix1);
      osc2.connect(mix2);
      mix1.connect(filter);
      mix2.connect(filter);
      filter.connect(gain);
      gain.connect(this.ctx.destination);
      
      osc1.start(t);
      osc2.start(t);
      osc1.stop(t + duration + 0.1);
      osc2.stop(t + duration + 0.1);
    } catch(e) {}
  },
  
  // Bass drum
  playKick(startTime, volume) {
    if (!this.ctx || !this.playing) return;
    try {
      const t = this.ctx.currentTime + startTime;
      const osc = this.ctx.createOscillator();
      const gain = this.ctx.createGain();
      
      osc.type = 'sine';
      osc.frequency.setValueAtTime(150, t);
      osc.frequency.exponentialRampToValueAtTime(40, t + 0.1);
      
      gain.gain.setValueAtTime(volume, t);
      gain.gain.exponentialRampToValueAtTime(0.001, t + 0.3);
      
      osc.connect(gain);
      gain.connect(this.ctx.destination);
      osc.start(t);
      osc.stop(t + 0.3);
    } catch(e) {}
  },
  
  // Hi-hat
  playHat(startTime, volume) {
    if (!this.ctx || !this.playing) return;
    try {
      const t = this.ctx.currentTime + startTime;
      const bufferSize = this.ctx.sampleRate * 0.05;
      const buffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
      const data = buffer.getChannelData(0);
      for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
      
      const noise = this.ctx.createBufferSource();
      noise.buffer = buffer;
      
      const filter = this.ctx.createBiquadFilter();
      filter.type = 'highpass';
      filter.frequency.value = 8000;
      
      const gain = this.ctx.createGain();
      gain.gain.setValueAtTime(volume, t);
      gain.gain.exponentialRampToValueAtTime(0.001, t + 0.05);
      
      noise.connect(filter);
      filter.connect(gain);
      gain.connect(this.ctx.destination);
      noise.start(t);
    } catch(e) {}
  },
  
  playMelody() {
    if (!this.playing) return;
    
    const n = this.notes;
    const bpm = 140; // Upbeat tempo!
    const beat = 60 / bpm;
    
    // 16-bar upbeat loop
    for (let bar = 0; bar < 16; bar++) {
      const barStart = bar * 4 * beat;
      
      // Drum pattern - kick on 1 and 3, hat on all beats
      this.playKick(barStart, 0.12);
      this.playKick(barStart + 2 * beat, 0.10);
      for (let i = 0; i < 4; i++) {
        this.playHat(barStart + i * beat, 0.04);
        this.playHat(barStart + i * beat + beat/2, 0.025);
      }
      
      // Bass line - bouncy!
      if (bar % 4 === 0) {
        this.playTone(n.C3, beat * 0.8, barStart, 'sawtooth', 0.08);
        this.playTone(n.C3, beat * 0.4, barStart + beat, 'sawtooth', 0.06);
        this.playTone(n.E3, beat * 0.8, barStart + beat * 2, 'sawtooth', 0.08);
        this.playTone(n.G3, beat * 0.4, barStart + beat * 3, 'sawtooth', 0.06);
      } else if (bar % 4 === 1) {
        this.playTone(n.A3, beat * 0.8, barStart, 'sawtooth', 0.08);
        this.playTone(n.A3, beat * 0.4, barStart + beat, 'sawtooth', 0.06);
        this.playTone(n.E3, beat * 0.8, barStart + beat * 2, 'sawtooth', 0.08);
        this.playTone(n.A3, beat * 0.4, barStart + beat * 3, 'sawtooth', 0.06);
      } else if (bar % 4 === 2) {
        this.playTone(n.F3, beat * 0.8, barStart, 'sawtooth', 0.08);
        this.playTone(n.F3, beat * 0.4, barStart + beat, 'sawtooth', 0.06);
        this.playTone(n.A3, beat * 0.8, barStart + beat * 2, 'sawtooth', 0.08);
        this.playTone(n.C4, beat * 0.4, barStart + beat * 3, 'sawtooth', 0.06);
      } else {
        this.playTone(n.G3, beat * 0.8, barStart, 'sawtooth', 0.08);
        this.playTone(n.G3, beat * 0.4, barStart + beat, 'sawtooth', 0.06);
        this.playTone(n.B3, beat * 0.8, barStart + beat * 2, 'sawtooth', 0.08);
        this.playTone(n.D4, beat * 0.4, barStart + beat * 3, 'sawtooth', 0.06);
      }
    }
    
    // Trumpet melody - catchy and upbeat!
    // Phrase 1 (bars 0-3)
    this.playTrumpet(n.E5, beat * 0.5, beat * 0, 0.06);
    this.playTrumpet(n.G5, beat * 0.5, beat * 0.5, 0.06);
    this.playTrumpet(n.A5, beat * 1.5, beat * 1, 0.07);
    this.playTrumpet(n.G5, beat * 0.5, beat * 3, 0.05);
    this.playTrumpet(n.E5, beat * 1, beat * 4, 0.06);
    this.playTrumpet(n.D5, beat * 0.5, beat * 5.5, 0.05);
    this.playTrumpet(n.C5, beat * 1.5, beat * 6, 0.06);
    
    // Phrase 2 (bars 4-7)
    this.playTrumpet(n.C5, beat * 0.5, beat * 8, 0.06);
    this.playTrumpet(n.E5, beat * 0.5, beat * 8.5, 0.06);
    this.playTrumpet(n.G5, beat * 1, beat * 9, 0.07);
    this.playTrumpet(n.E5, beat * 0.5, beat * 10.5, 0.05);
    this.playTrumpet(n.C5, beat * 1, beat * 11, 0.06);
    this.playTrumpet(n.D5, beat * 0.5, beat * 12.5, 0.05);
    this.playTrumpet(n.E5, beat * 1.5, beat * 13, 0.07);
    
    // Phrase 3 (bars 8-11) - higher energy!
    this.playTrumpet(n.G5, beat * 0.5, beat * 16, 0.07);
    this.playTrumpet(n.A5, beat * 0.5, beat * 16.5, 0.07);
    this.playTrumpet(n.G5, beat * 0.5, beat * 17, 0.06);
    this.playTrumpet(n.E5, beat * 0.5, beat * 17.5, 0.06);
    this.playTrumpet(n.G5, beat * 1.5, beat * 18, 0.08);
    this.playTrumpet(n.E5, beat * 0.5, beat * 20, 0.06);
    this.playTrumpet(n.D5, beat * 0.5, beat * 20.5, 0.05);
    this.playTrumpet(n.C5, beat * 0.5, beat * 21, 0.05);
    this.playTrumpet(n.D5, beat * 1.5, beat * 22, 0.06);
    
    // Phrase 4 (bars 12-15) - triumphant ending!
    this.playTrumpet(n.C5, beat * 0.5, beat * 24, 0.06);
    this.playTrumpet(n.E5, beat * 0.5, beat * 24.5, 0.06);
    this.playTrumpet(n.G5, beat * 0.5, beat * 25, 0.07);
    this.playTrumpet(n.C5, beat * 0.3, beat * 25.5, 0.05);
    this.playTrumpet(n.E5, beat * 0.3, beat * 25.8, 0.05);
    this.playTrumpet(n.G5, beat * 0.3, beat * 26.1, 0.06);
    this.playTrumpet(n.A5, beat * 2, beat * 26.5, 0.08); // Big high note!
    this.playTrumpet(n.G5, beat * 1.5, beat * 29, 0.07);
    this.playTrumpet(n.E5, beat * 2, beat * 31, 0.06);
    
    // Chords for fullness
    for (let bar = 0; bar < 16; bar += 2) {
      const t = bar * 4 * beat;
      if (bar % 8 < 4) {
        this.playTone(n.C4, beat * 3, t, 'triangle', 0.03);
        this.playTone(n.E4, beat * 3, t, 'triangle', 0.025);
        this.playTone(n.G4, beat * 3, t, 'triangle', 0.025);
      } else {
        this.playTone(n.A3, beat * 3, t, 'triangle', 0.03);
        this.playTone(n.C4, beat * 3, t, 'triangle', 0.025);
        this.playTone(n.E4, beat * 3, t, 'triangle', 0.025);
      }
    }
    
    // Loop after 16 bars
    const loopTime = 16 * 4 * beat * 1000;
    this.loopTimeout = setTimeout(() => this.playMelody(), loopTime);
  },
  
  playVictory() {
    if (!this.ctx) this.init();
    this.resume();
    const n = this.notes;
    this.playTrumpet(n.C5, 0.2, 0, 0.1);
    this.playTrumpet(n.E5, 0.2, 0.15, 0.1);
    this.playTrumpet(n.G5, 0.2, 0.3, 0.1);
    this.playTrumpet(n.C5, 0.5, 0.5, 0.12);
    this.playKick(0.5, 0.15);
  },
  
  start() {
    if (!this.init()) return false;
    this.resume();
    this.playing = true;
    this.playMelody();
    return true;
  },
  
  stop() {
    this.playing = false;
    if (this.loopTimeout) { clearTimeout(this.loopTimeout); this.loopTimeout = null; }
  },
  
  toggle() {
    if (this.playing) { this.stop(); return false; }
    else { return this.start(); }
  }
};

// ============ GAME ============
const {useState, useEffect, useCallback, useRef} = React;
const h = React.createElement;

const CELL = 30;
const SPEEDS = {1:300,2:285,3:270,4:255,5:240,6:220,7:200,8:180,9:160,10:140,11:125,12:110};
const WALL=1, DOT=2, POWER=3, EMPTY=0, MAP_W=17, MAP_H=15;
const DEATH_MSGS = ["üíÄ Caught!", "üêâ Dragon fire!", "üë§ Villager got you!", "üü™ Teleported!", "‚ö° Too slow!"];

// Extended time limits - up to 2 minutes!
const TIME_LIMITS = {1:120,2:120,3:110,4:110,5:105,6:105,7:100,8:100,9:95,10:95,11:90,12:90};

const LEVELS = [
{map:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,3,2,2,2,2,2,2,2,2,2,2,2,2,2,3,1],[1,2,2,2,2,2,2,0,0,0,2,2,2,2,2,2,1],[1,2,2,2,2,2,2,0,0,0,2,2,2,2,2,2,1],[1,2,2,2,2,2,2,0,0,0,2,2,2,2,2,2,1],[1,3,2,2,2,2,2,2,2,2,2,2,2,2,2,3,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],enemies:[{type:'villager',x:8,y:7,slow:true}],start:{x:1,y:1}},
{map:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,2,2,1,2,2,2,2,2,2,2,1,2,2,2,1],[1,3,2,2,2,2,2,2,2,2,2,2,2,2,2,3,1],[1,2,2,2,2,2,2,0,0,0,2,2,2,2,2,2,1],[1,2,2,2,2,2,2,0,0,0,2,2,2,2,2,2,1],[1,2,2,2,2,2,2,0,0,0,2,2,2,2,2,2,1],[1,3,2,2,2,2,2,2,2,2,2,2,2,2,2,3,1],[1,2,2,2,1,2,2,2,2,2,2,2,1,2,2,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],enemies:[{type:'villager',x:8,y:7}],start:{x:1,y:1}},
{map:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,2,2,2,2,2,2,2,2,2,2,2,1,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,2,2,1,2,2,2,2,2,2,2,1,2,2,2,1],[1,3,2,2,2,2,2,2,2,2,2,2,2,2,2,3,1],[1,2,2,2,2,2,2,0,0,0,2,2,2,2,2,2,1],[1,2,2,2,2,2,2,0,0,0,2,2,2,2,2,2,1],[1,2,2,2,2,2,2,0,0,0,2,2,2,2,2,2,1],[1,3,2,2,2,2,2,2,2,2,2,2,2,2,2,3,1],[1,2,2,2,1,2,2,2,2,2,2,2,1,2,2,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,2,2,2,2,2,2,2,2,2,2,2,1,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],enemies:[{type:'villager',x:8,y:7}],start:{x:1,y:1}},
{map:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,1,2,1,2,2,1,2,2,1,2,1,1,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,2,1,2,1,1,1,1,1,2,1,2,1,2,1],[1,3,2,2,2,2,2,2,2,2,2,2,2,2,2,3,1],[1,2,1,2,1,2,1,0,0,0,1,2,1,2,1,2,1],[1,2,2,2,2,2,2,0,0,0,2,2,2,2,2,2,1],[1,2,1,2,1,2,1,0,0,0,1,2,1,2,1,2,1],[1,3,2,2,2,2,2,2,2,2,2,2,2,2,2,3,1],[1,2,1,2,1,2,1,1,1,1,1,2,1,2,1,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,1,2,1,2,2,1,2,2,1,2,1,1,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],enemies:[{type:'villager',x:8,y:7}],start:{x:1,y:1}},
{map:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,2,2,2,2,2,2,2,2,2,2,2,1,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,2,1,2,2,1,1,1,2,2,1,2,1,2,1],[1,3,2,2,2,2,2,2,2,2,2,2,2,2,2,3,1],[1,2,2,2,1,2,1,0,0,0,1,2,1,2,2,2,1],[1,2,2,2,2,2,2,0,0,0,2,2,2,2,2,2,1],[1,2,2,2,1,2,1,0,0,0,1,2,1,2,2,2,1],[1,3,2,2,2,2,2,2,2,2,2,2,2,2,2,3,1],[1,2,1,2,1,2,2,1,1,1,2,2,1,2,1,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,2,2,2,2,2,2,2,2,2,2,2,1,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],enemies:[{type:'dragon',x:8,y:7}],start:{x:1,y:1}},
{map:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,2,2,2,2,2,1,3,1,3,1,2,2,2,2,2,1],[1,2,1,1,1,2,1,2,2,2,1,2,1,1,1,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,2,1,1,2,1,1,1,2,1,1,2,1,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,1,1,2,1,2,1,0,0,0,1,2,1,2,1,1,1],[1,3,2,2,2,2,0,0,0,0,0,2,2,2,2,3,1],[1,1,1,2,1,2,1,0,0,0,1,2,1,2,1,1,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,2,1,1,2,1,1,1,2,1,1,2,1,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,1,1,2,1,2,2,2,1,2,1,1,1,2,1],[1,2,2,2,2,2,1,3,1,3,1,2,2,2,2,2,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],enemies:[{type:'villager',x:8,y:7},{type:'enderman',x:7,y:7}],start:{x:1,y:1}},
{map:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,1,2,1,1,2,1,2,1,1,2,1,1,2,1],[1,3,2,2,2,2,2,2,2,2,2,2,2,2,2,3,1],[1,2,1,2,1,2,1,1,1,1,1,2,1,2,1,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,1,1,2,1,2,1,0,0,0,1,2,1,2,1,1,1],[1,2,2,2,2,2,0,0,0,0,0,2,2,2,2,2,1],[1,1,1,2,1,2,1,0,0,0,1,2,1,2,1,1,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,2,1,2,1,1,1,1,1,2,1,2,1,2,1],[1,3,2,2,2,2,2,2,2,2,2,2,2,2,2,3,1],[1,2,1,1,2,1,1,2,1,2,1,1,2,1,1,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],enemies:[{type:'villager',x:8,y:7},{type:'dragon',x:7,y:7}],start:{x:1,y:1}},
{map:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,2,2,2,2,2,2,1,3,1,2,2,2,2,2,2,1],[1,2,1,1,1,2,1,1,2,1,1,2,1,1,1,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,2,1,1,2,1,2,1,2,1,1,2,1,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,1,1,2,1,2,1,0,0,0,1,2,1,2,1,1,1],[1,3,2,2,2,2,0,0,0,0,0,2,2,2,2,3,1],[1,1,1,2,1,2,1,0,0,0,1,2,1,2,1,1,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,2,1,1,2,1,2,1,2,1,1,2,1,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,1,1,2,1,1,2,1,1,2,1,1,1,2,1],[1,2,2,2,2,2,2,1,3,1,2,2,2,2,2,2,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],enemies:[{type:'villager',x:8,y:7},{type:'enderman',x:7,y:7},{type:'dragon',x:9,y:7}],start:{x:1,y:1}},
{map:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,3,1,1,2,1,1,2,1,2,1,1,2,1,1,3,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,2,1,2,1,1,1,1,1,2,1,2,1,2,1],[1,2,2,2,1,2,2,2,2,2,2,2,1,2,2,2,1],[1,1,1,2,1,1,1,0,0,0,1,1,1,2,1,1,1],[0,2,2,2,2,2,0,0,0,0,0,2,2,2,2,2,0],[1,1,1,2,1,1,1,0,0,0,1,1,1,2,1,1,1],[1,2,2,2,1,2,2,2,2,2,2,2,1,2,2,2,1],[1,2,1,2,1,2,1,1,1,1,1,2,1,2,1,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,3,1,1,2,1,1,2,1,2,1,1,2,1,1,3,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],enemies:[{type:'villager',x:8,y:7},{type:'enderman',x:6,y:7},{type:'enderman',x:10,y:7},{type:'dragon',x:8,y:6}],start:{x:1,y:1}},
{map:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,2,2,2,2,1,2,2,3,2,2,1,2,2,2,2,1],[1,2,1,1,2,1,2,1,1,1,2,1,2,1,1,2,1],[1,2,1,2,2,2,2,2,2,2,2,2,2,2,1,2,1],[1,2,2,2,1,1,2,1,2,1,2,1,1,2,2,2,1],[1,1,1,2,2,2,2,2,2,2,2,2,2,2,1,1,1],[1,2,2,2,1,1,1,0,0,0,1,1,1,2,2,2,1],[1,3,1,2,1,0,0,0,0,0,0,0,1,2,1,3,1],[1,2,2,2,1,1,1,0,0,0,1,1,1,2,2,2,1],[1,1,1,2,2,2,2,2,2,2,2,2,2,2,1,1,1],[1,2,2,2,1,1,2,1,2,1,2,1,1,2,2,2,1],[1,2,1,2,2,2,2,2,2,2,2,2,2,2,1,2,1],[1,2,1,1,2,1,2,1,1,1,2,1,2,1,1,2,1],[1,2,2,2,2,1,2,2,3,2,2,1,2,2,2,2,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],enemies:[{type:'villager',x:8,y:7},{type:'enderman',x:6,y:7},{type:'enderman',x:10,y:7},{type:'dragon',x:7,y:7},{type:'dragon',x:9,y:7}],start:{x:1,y:1}},
{map:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,1,1,2,1,1,1,1,1,2,1,1,1,2,1],[1,3,1,2,2,2,2,2,2,2,2,2,2,2,1,3,1],[1,2,1,2,1,1,2,1,2,1,2,1,1,2,1,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,1,1,1,1,2,1,0,0,0,1,2,1,1,1,1,1],[0,2,2,2,2,2,0,0,0,0,0,2,2,2,2,2,0],[1,1,1,1,1,2,1,0,0,0,1,2,1,1,1,1,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,2,1,1,2,1,2,1,2,1,1,2,1,2,1],[1,3,1,2,2,2,2,2,2,2,2,2,2,2,1,3,1],[1,2,1,1,1,2,1,1,1,1,1,2,1,1,1,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],enemies:[{type:'enderman',x:5,y:7},{type:'enderman',x:11,y:7},{type:'dragon',x:7,y:7},{type:'dragon',x:8,y:7},{type:'dragon',x:9,y:7}],start:{x:1,y:1}},
{map:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,1,1,1,2,1,1,1,2,1,1,1,1,2,1],[1,3,1,2,2,2,2,2,2,2,2,2,2,2,1,3,1],[1,2,1,2,1,1,1,2,1,2,1,1,1,2,1,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,1,1,1,1,2,1,0,0,0,1,2,1,1,1,1,1],[0,2,2,2,2,2,0,0,0,0,0,2,2,2,2,2,0],[1,1,1,1,1,2,1,0,0,0,1,2,1,1,1,1,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,2,1,2,1,1,1,2,1,2,1,1,1,2,1,2,1],[1,3,1,2,2,2,2,2,2,2,2,2,2,2,1,3,1],[1,2,1,1,1,1,2,1,1,1,2,1,1,1,1,2,1],[1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],enemies:[{type:'dragon',x:6,y:7},{type:'dragon',x:7,y:7},{type:'dragon',x:8,y:7},{type:'dragon',x:9,y:7},{type:'dragon',x:10,y:7}],start:{x:1,y:1}}
];

function Game() {
  const [currentLevel, setCurrentLevel] = useState(0);
  const [startingLevel, setStartingLevel] = useState(1);
  const [selectedLevel, setSelectedLevel] = useState(1);
  const [gameMap, setGameMap] = useState([]);
  const [steve, setSteve] = useState({x:1,y:1});
  const [steveDir, setSteveDir] = useState({x:0,y:0});
  const [enemies, setEnemies] = useState([]);
  const [score, setScore] = useState(0);
  const [lives, setLives] = useState(3);
  const [gameOver, setGameOver] = useState(false);
  const [gameStarted, setGameStarted] = useState(false);
  const [isPaused, setIsPaused] = useState(false);
  const [powerMode, setPowerMode] = useState(false);
  const [powerTimer, setPowerTimer] = useState(null);
  const [mouthOpen, setMouthOpen] = useState(true);
  const [showRules, setShowRules] = useState(false);
  const [showLeaderboard, setShowLeaderboard] = useState(false);
  const [showNameEntry, setShowNameEntry] = useState(false);
  const [playerName, setPlayerName] = useState('');
  const [pendingScore, setPendingScore] = useState(0);
  const [waitingToStart, setWaitingToStart] = useState(true);
  const [showDeath, setShowDeath] = useState(false);
  const [deathMsg, setDeathMsg] = useState('');
  const [soundOn, setSoundOn] = useState(false);
  const [levelTime, setLevelTime] = useState(0);
  const [leaderboard, setLeaderboard] = useState(() => {
    try { return JSON.parse(localStorage.getItem('mm-lb5')) || []; } catch { return []; }
  });
  
  const touchStart = useRef({x:0,y:0,time:0});
  const nextDir = useRef({x:0,y:0});
  const currentDir = useRef({x:0,y:0});
  const nameInput = useRef(null);
  const timerRef = useRef(null);

  const toggleSound = () => { const isOn = MusicEngine.toggle(); setSoundOn(isOn); };

  const getLevelBonus = (start, end) => {
    let bonus = 0;
    for (let i = start; i <= end; i++) bonus += i * 100;
    return bonus;
  };

  const getTimeBonus = (lvl, timeTaken) => {
    const limit = TIME_LIMITS[lvl] || 120;
    return Math.max(0, Math.floor((limit - timeTaken) * 10));
  };

  const checkLeaderboard = useCallback((fs) => {
    if (leaderboard.length < 10 || fs > (leaderboard[leaderboard.length-1]?.score || 0)) {
      setPendingScore(fs);
      setShowNameEntry(true);
      setTimeout(() => nameInput.current?.focus(), 100);
      return true;
    }
    return false;
  }, [leaderboard]);

  const saveToLeaderboard = useCallback((name, sc) => {
    const entry = {name: name.trim() || 'Anon', score: sc, date: new Date().toLocaleDateString(), start: startingLevel};
    const newBoard = [...leaderboard, entry].sort((a,b) => b.score - a.score).slice(0, 10);
    setLeaderboard(newBoard);
    localStorage.setItem('mm-lb5', JSON.stringify(newBoard));
    setShowNameEntry(false);
    setPlayerName('');
  }, [leaderboard, startingLevel]);

  const initLevel = useCallback((idx, posOnly = false) => {
    const lvl = LEVELS[idx];
    if (!posOnly) setGameMap(lvl.map.map(r => [...r]));
    setSteve({...lvl.start});
    setSteveDir({x:0,y:0});
    currentDir.current = {x:0,y:0};
    nextDir.current = {x:0,y:0};
    setEnemies(lvl.enemies.map((e, i) => ({...e, startX: e.x, startY: e.y, id: i, dir: {x:0,y:0}})));
    setPowerMode(false);
    setWaitingToStart(true);
    setLevelTime(0);
    if (powerTimer) clearTimeout(powerTimer);
    if (timerRef.current) clearInterval(timerRef.current);
  }, [powerTimer]);

  const startGame = (lvl = selectedLevel) => {
    setCurrentLevel(lvl - 1);
    setStartingLevel(lvl);
    setScore(0);
    setLives(3);
    setGameOver(false);
    setGameStarted(true);
    setIsPaused(false);
    setShowRules(false);
    setShowLeaderboard(false);
    setShowDeath(false);
    initLevel(lvl - 1);
  };

  const startRound = () => {
    setWaitingToStart(false);
    setShowDeath(false);
    setLevelTime(0);
    if (timerRef.current) clearInterval(timerRef.current);
    timerRef.current = setInterval(() => setLevelTime(t => t + 1), 1000);
  };

  const isValid = useCallback((x, y, map) => {
    if (y < 0 || y >= MAP_H) return false;
    return map[y][(x + MAP_W) % MAP_W] !== WALL;
  }, []);

  const countDots = useCallback((map) => map.flat().filter(c => c === DOT || c === POWER).length, []);

  const handleDir = useCallback((dir) => {
    if (!gameStarted || gameOver || isPaused || waitingToStart) return;
    nextDir.current = dir;
  }, [gameStarted, gameOver, isPaused, waitingToStart]);

  const handleTouchStart = (e) => {
    const t = e.touches[0];
    touchStart.current = {x: t.clientX, y: t.clientY, time: Date.now()};
  };

  const handleTouchMove = (e) => {
    if (gameStarted && !gameOver && !isPaused && !waitingToStart) e.preventDefault();
  };

  const handleTouchEnd = (e) => {
    if (!gameStarted || gameOver || isPaused || waitingToStart) return;
    const t = e.changedTouches[0];
    const dx = t.clientX - touchStart.current.x;
    const dy = t.clientY - touchStart.current.y;
    const dt = Date.now() - touchStart.current.time;
    if (dt < 400) {
      const ax = Math.abs(dx), ay = Math.abs(dy);
      if (ax > 15 || ay > 15) {
        if (ax > ay) handleDir(dx > 0 ? {x:1,y:0} : {x:-1,y:0});
        else handleDir(dy > 0 ? {x:0,y:1} : {x:0,y:-1});
      }
    }
  };

  useEffect(() => {
    const onKey = (e) => {
      if (showNameEntry) return;
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        if (!gameStarted) startGame();
        else if (waitingToStart && !gameOver) startRound();
        else if (gameOver) startGame();
        return;
      }
      if (e.key === 'Escape') {
        e.preventDefault();
        if (showRules) setShowRules(false);
        else if (showLeaderboard) setShowLeaderboard(false);
        else if (gameStarted && !gameOver && !waitingToStart) setIsPaused(p => !p);
        return;
      }
      if ((e.key === 'p' || e.key === 'P') && gameStarted && !gameOver && !waitingToStart) { e.preventDefault(); setIsPaused(p => !p); return; }
      if (e.key === 'm' || e.key === 'M') { e.preventDefault(); toggleSound(); return; }
      const dirs = {ArrowUp:{x:0,y:-1},w:{x:0,y:-1},W:{x:0,y:-1},ArrowDown:{x:0,y:1},s:{x:0,y:1},S:{x:0,y:1},ArrowLeft:{x:-1,y:0},a:{x:-1,y:0},A:{x:-1,y:0},ArrowRight:{x:1,y:0},d:{x:1,y:0},D:{x:1,y:0}};
      if (dirs[e.key]) { e.preventDefault(); handleDir(dirs[e.key]); }
    };
    window.addEventListener('keydown', onKey);
    return () => window.removeEventListener('keydown', onKey);
  }, [gameStarted, gameOver, handleDir, showRules, showLeaderboard, showNameEntry, waitingToStart]);

  useEffect(() => {
    if (isPaused && timerRef.current) {
      clearInterval(timerRef.current);
      timerRef.current = null;
    } else if (!isPaused && gameStarted && !waitingToStart && !gameOver) {
      timerRef.current = setInterval(() => setLevelTime(t => t + 1), 1000);
    }
    return () => { if (timerRef.current) clearInterval(timerRef.current); };
  }, [isPaused, gameStarted, waitingToStart, gameOver]);

  const moveEnemies = useCallback((map, sPos, isPower) => {
    setEnemies(prev => prev.map(en => {
      if (en.slow && Math.random() < 0.5) return en;
      const dirs = [{x:1,y:0},{x:-1,y:0},{x:0,y:1},{x:0,y:-1}];
      const valid = dirs.filter(d => {
        const nx = (en.x + d.x + MAP_W) % MAP_W, ny = en.y + d.y;
        return isValid(nx, ny, map) && !(d.x === -en.dir.x && d.y === -en.dir.y);
      });
      if (valid.length === 0) {
        const any = dirs.filter(d => isValid((en.x + d.x + MAP_W) % MAP_W, en.y + d.y, map));
        if (any.length === 0) return en;
        const d = any[Math.floor(Math.random() * any.length)];
        return {...en, x: (en.x + d.x + MAP_W) % MAP_W, y: en.y + d.y, dir: d};
      }
      let pick;
      if (isPower) {
        valid.sort((a,b) => (Math.abs(en.x+b.x-sPos.x)+Math.abs(en.y+b.y-sPos.y)) - (Math.abs(en.x+a.x-sPos.x)+Math.abs(en.y+a.y-sPos.y)));
        pick = valid[0];
      } else {
        if (Math.random() < 0.6) {
          valid.sort((a,b) => (Math.abs(en.x+a.x-sPos.x)+Math.abs(en.y+a.y-sPos.y)) - (Math.abs(en.x+b.x-sPos.x)+Math.abs(en.y+b.y-sPos.y)));
          pick = valid[0];
        } else pick = valid[Math.floor(Math.random() * valid.length)];
      }
      return {...en, x: (en.x + pick.x + MAP_W) % MAP_W, y: en.y + pick.y, dir: pick};
    }));
  }, [isValid]);

  useEffect(() => {
    if (!gameStarted || gameOver || isPaused || waitingToStart) return;
    const spd = SPEEDS[currentLevel + 1] || 200;
    const loop = setInterval(() => {
      setMouthOpen(m => !m);
      setSteve(prev => {
        let nd = currentDir.current;
        const tx = (prev.x + nextDir.current.x + MAP_W) % MAP_W, ty = prev.y + nextDir.current.y;
        if ((nextDir.current.x || nextDir.current.y) && isValid(tx, ty, gameMap)) {
          nd = nextDir.current;
          currentDir.current = nd;
          setSteveDir(nd);
        }
        const nx = (prev.x + nd.x + MAP_W) % MAP_W, ny = prev.y + nd.y;
        if (!isValid(nx, ny, gameMap)) return prev;
        if (gameMap[ny][nx] === DOT) {
          setGameMap(m => { const nm = m.map(r => [...r]); nm[ny][nx] = EMPTY; return nm; });
          setScore(s => s + 10);
        }
        if (gameMap[ny][nx] === POWER) {
          setGameMap(m => { const nm = m.map(r => [...r]); nm[ny][nx] = EMPTY; return nm; });
          setScore(s => s + 50);
          setPowerMode(true);
          if (powerTimer) clearTimeout(powerTimer);
          setPowerTimer(setTimeout(() => setPowerMode(false), 8000));
        }
        return {x: nx, y: ny};
      });
      if (Math.random() < 0.5) moveEnemies(gameMap, steve, powerMode);
    }, spd);
    return () => clearInterval(loop);
  }, [gameStarted, gameOver, isPaused, waitingToStart, gameMap, steve, powerMode, isValid, moveEnemies, currentLevel, powerTimer]);

  useEffect(() => {
    if (!gameStarted || gameOver || waitingToStart) return;
    for (const en of enemies) {
      if (en.x === steve.x && en.y === steve.y) {
        if (powerMode) {
          setScore(s => s + 200);
          setEnemies(p => p.map(e => e.id === en.id ? {...e, x: e.startX, y: e.startY} : e));
        } else {
          if (timerRef.current) clearInterval(timerRef.current);
          setLives(l => {
            const nl = l - 1;
            if (nl <= 0) {
              setGameOver(true);
              const fs = score + getLevelBonus(startingLevel, currentLevel);
              setScore(fs);
              checkLeaderboard(fs);
            } else {
              setDeathMsg(DEATH_MSGS[Math.floor(Math.random() * DEATH_MSGS.length)]);
              setShowDeath(true);
              initLevel(currentLevel, true);
            }
            return nl;
          });
        }
      }
    }
    if (countDots(gameMap) === 0) {
      if (timerRef.current) clearInterval(timerRef.current);
      const timeBonus = getTimeBonus(currentLevel + 1, levelTime);
      setScore(s => s + timeBonus);
      MusicEngine.playVictory();
      
      const next = currentLevel + 1;
      if (next < LEVELS.length) {
        setCurrentLevel(next);
        initLevel(next);
      } else {
        const fs = score + timeBonus + getLevelBonus(startingLevel, LEVELS.length) + 500;
        setGameOver(true);
        setScore(fs);
        checkLeaderboard(fs);
      }
    }
  }, [steve, enemies, gameMap, powerMode, gameStarted, gameOver, waitingToStart, currentLevel, initLevel, countDots, score, checkLeaderboard, startingLevel, levelTime]);

  // ============ 3D RENDERERS (flat view) ============
  
  const renderSteve = () => {
    const rot = steveDir.x === 1 ? 0 : steveDir.x === -1 ? 180 : steveDir.y === 1 ? 90 : steveDir.y === -1 ? -90 : 0;
    return h('div', {style: {
      position:'absolute',
      left: steve.x * CELL,
      top: steve.y * CELL,
      width: CELL,
      height: CELL,
      transition: 'left 0.1s, top 0.1s',
      zIndex: 20,
      filter: 'drop-shadow(2px 3px 3px rgba(0,0,0,0.7))'
    }},
      h('div', {style: {
        width: CELL - 4,
        height: CELL - 4,
        margin: 2,
        background: 'linear-gradient(145deg, #f0d8b0, #c69c6d, #8b6914)',
        border: '2px solid #5a3a1a',
        borderRadius: 4,
        position: 'relative',
        transform: `rotate(${rot}deg)`,
        boxShadow: 'inset 3px 3px 2px rgba(255,255,255,0.5), inset -2px -2px 2px rgba(0,0,0,0.4)'
      }}, [
        h('div',{key:'hair',style:{position:'absolute',top:0,left:0,right:0,height:'40%',background:'linear-gradient(180deg,#6a4a2a,#3b2210)',borderRadius:'4px 4px 0 0'}}),
        h('div',{key:'e1',style:{position:'absolute',top:'44%',left:'12%',width:'25%',height:'22%',background:'#fff',borderRadius:2}},h('div',{style:{position:'absolute',right:0,top:0,width:'55%',height:'100%',background:'linear-gradient(180deg,#5ab4e8,#2a84c8)',borderRadius:1}})),
        h('div',{key:'e2',style:{position:'absolute',top:'44%',right:'12%',width:'25%',height:'22%',background:'#fff',borderRadius:2}},h('div',{style:{position:'absolute',left:0,top:0,width:'55%',height:'100%',background:'linear-gradient(180deg,#5ab4e8,#2a84c8)',borderRadius:1}})),
        h('div',{key:'m',style:{position:'absolute',bottom:'12%',left:'28%',width:mouthOpen?'44%':'22%',height:'16%',background:'#5a3a2a',borderRadius:2,transition:'width 0.1s'}})
      ])
    );
  };

  const renderEnderman = (en) => {
    const sc = powerMode;
    return h('div',{key:'en-'+en.id,style:{position:'absolute',left:en.x*CELL,top:en.y*CELL,width:CELL,height:CELL,transition:'left 0.15s,top 0.15s',zIndex:15,filter:'drop-shadow(2px 4px 4px rgba(0,0,0,0.8))'}},
      h('div',{style:{width:CELL-10,height:CELL-2,margin:'1px 5px',background:sc?'linear-gradient(180deg,#6688ff,#3355dd)':'linear-gradient(180deg,#1a1a1a,#000)',border:sc?'3px solid #88aaff':'3px solid #6600cc',borderRadius:'6px 6px 3px 3px',position:'relative',boxShadow:sc?'0 0 20px rgba(100,150,255,0.8)':'0 0 15px rgba(128,0,255,0.5)',animation:'float 2s ease-in-out infinite'}},[
        h('div',{key:'b',style:{position:'absolute',top:'25%',left:'36%',width:'28%',height:'70%',background:sc?'#4466dd':'#0a0a0a',borderRadius:3}}),
        h('div',{key:'e1',style:{position:'absolute',top:'16%',left:'3%',width:'44%',height:'14%',background:sc?'#fff':'#ff00ff',borderRadius:3,boxShadow:sc?'0 0 15px #fff':'0 0 20px #ff00ff,0 0 40px #cc00ff'}}),
        h('div',{key:'e2',style:{position:'absolute',top:'16%',right:'3%',width:'44%',height:'14%',background:sc?'#fff':'#ff00ff',borderRadius:3,boxShadow:sc?'0 0 15px #fff':'0 0 20px #ff00ff,0 0 40px #cc00ff'}}),
        !sc&&h('div',{key:'p1',style:{position:'absolute',top:'-8px',left:'15%',width:6,height:6,background:'#cc00ff',borderRadius:'50%',animation:'particleFloat 2s ease-out infinite'}}),
        !sc&&h('div',{key:'p2',style:{position:'absolute',top:'-4px',right:'20%',width:4,height:4,background:'#aa44ff',borderRadius:'50%',animation:'particleFloat 2.5s ease-out infinite 0.5s'}})
      ])
    );
  };

  const renderDragon = (en) => {
    const sc = powerMode;
    return h('div',{key:'dr-'+en.id,style:{position:'absolute',left:en.x*CELL,top:en.y*CELL,width:CELL,height:CELL,transition:'left 0.15s,top 0.15s',zIndex:15,filter:'drop-shadow(3px 4px 4px rgba(0,0,0,0.8))'}},
      h('div',{style:{width:CELL+4,height:CELL-2,margin:'1px -2px',background:sc?'linear-gradient(180deg,#6688ff,#3355dd)':'linear-gradient(180deg,#7a4daa,#5a2d8a,#3a1d6a)',border:sc?'3px solid #88aaff':'3px solid #aa66dd',borderRadius:'14px 14px 10px 10px',position:'relative',boxShadow:sc?'0 0 20px rgba(100,150,255,0.8)':'0 0 15px rgba(150,85,200,0.6)'}},[
        h('div',{key:'wl',style:{position:'absolute',top:'8%',left:'-12px',width:14,height:20,background:sc?'#99bbff':'linear-gradient(90deg,#9a5dca,#6a3d9a)',borderRadius:'12px 4px 4px 12px',transformOrigin:'right center',animation:'wingFlap 0.6s ease-in-out infinite',boxShadow:'inset 2px 0 4px rgba(255,255,255,0.3)'}}),
        h('div',{key:'wr',style:{position:'absolute',top:'8%',right:'-12px',width:14,height:20,background:sc?'#99bbff':'linear-gradient(-90deg,#9a5dca,#6a3d9a)',borderRadius:'4px 12px 12px 4px',transformOrigin:'left center',animation:'wingFlap 0.6s ease-in-out infinite',boxShadow:'inset -2px 0 4px rgba(255,255,255,0.3)'}}),
        h('div',{key:'hl',style:{position:'absolute',top:'-10px',left:'10%',width:8,height:14,background:sc?'#aaa':'linear-gradient(180deg,#5a4d7a,#3a2d5a)',borderRadius:'4px 4px 2px 2px',transform:'rotate(-25deg)',boxShadow:'1px 1px 3px rgba(0,0,0,0.5)'}}),
        h('div',{key:'hr',style:{position:'absolute',top:'-10px',right:'10%',width:8,height:14,background:sc?'#aaa':'linear-gradient(180deg,#5a4d7a,#3a2d5a)',borderRadius:'4px 4px 2px 2px',transform:'rotate(25deg)',boxShadow:'1px 1px 3px rgba(0,0,0,0.5)'}}),
        h('div',{key:'e1',style:{position:'absolute',top:'16%',left:'6%',width:'38%',height:'38%',background:sc?'radial-gradient(#fff,#ddd)':'radial-gradient(circle at 30% 30%,#ffaaff,#ff44ff,#cc00cc)',borderRadius:'50%',boxShadow:sc?'0 0 15px #fff':'0 0 20px #ff00ff,inset 3px 3px 6px rgba(255,255,255,0.5)'}}),
        h('div',{key:'e2',style:{position:'absolute',top:'16%',right:'6%',width:'38%',height:'38%',background:sc?'radial-gradient(#fff,#ddd)':'radial-gradient(circle at 30% 30%,#ffaaff,#ff44ff,#cc00cc)',borderRadius:'50%',boxShadow:sc?'0 0 15px #fff':'0 0 20px #ff00ff,inset 3px 3px 6px rgba(255,255,255,0.5)'}}),
        h('div',{key:'sn',style:{position:'absolute',bottom:'6%',left:'26%',width:'48%',height:'30%',background:sc?'#7799dd':'linear-gradient(180deg,#5a4d7a,#4a3d6a)',borderRadius:'5px 5px 12px 12px'}}),
        !sc&&h('div',{key:'n1',style:{position:'absolute',bottom:'14%',left:'30%',width:7,height:7,background:'radial-gradient(#ff8800,#ff4400)',borderRadius:'50%',boxShadow:'0 0 10px #ff4400,0 0 18px #ff2200'}}),
        !sc&&h('div',{key:'n2',style:{position:'absolute',bottom:'14%',right:'30%',width:7,height:7,background:'radial-gradient(#ff8800,#ff4400)',borderRadius:'50%',boxShadow:'0 0 10px #ff4400,0 0 18px #ff2200'}})
      ])
    );
  };

  const renderVillager = (en) => {
    const sc = powerMode;
    return h('div',{key:'vi-'+en.id,style:{position:'absolute',left:en.x*CELL,top:en.y*CELL,width:CELL,height:CELL,transition:'left 0.15s,top 0.15s',zIndex:15,filter:'drop-shadow(2px 3px 3px rgba(0,0,0,0.6))'}},
      h('div',{style:{width:CELL-4,height:CELL-4,margin:2,background:sc?'linear-gradient(180deg,#6688ff,#3355dd)':'linear-gradient(180deg,#d8b888,#b89868,#907040)',border:sc?'3px solid #88aaff':'3px solid #705030',borderRadius:'12px 12px 8px 8px',position:'relative',boxShadow:sc?'0 0 20px rgba(100,150,255,0.8)':'inset 3px 3px 4px rgba(255,255,255,0.3)'}},[
        h('div',{key:'h',style:{position:'absolute',top:0,left:0,right:0,height:'32%',background:sc?'linear-gradient(180deg,#7799ff,#5577ee)':'linear-gradient(180deg,#b89868,#987848)',borderRadius:'12px 12px 0 0'}}),
        h('div',{key:'f',style:{position:'absolute',top:'34%',left:'18%',width:'64%',height:'50%',background:sc?'#aaccff':'linear-gradient(180deg,#f0d8b8,#d8b898)',borderRadius:5}}),
        h('div',{key:'n',style:{position:'absolute',top:'40%',left:'28%',width:'44%',height:'52%',background:sc?'#99bbff':'linear-gradient(180deg,#e8c8a8,#c8a888)',borderRadius:'6px 6px 14px 14px',boxShadow:'2px 2px 5px rgba(0,0,0,0.3)'}}),
        h('div',{key:'b',style:{position:'absolute',top:'34%',left:'8%',width:'84%',height:'14%',background:sc?'#fff':'#5a4530',borderRadius:4}}),
        h('div',{key:'e1',style:{position:'absolute',top:'48%',left:'12%',width:'22%',height:'20%',background:sc?'#fff':'#3d6c3d',borderRadius:'50%'}}),
        h('div',{key:'e2',style:{position:'absolute',top:'48%',right:'12%',width:'22%',height:'20%',background:sc?'#fff':'#3d6c3d',borderRadius:'50%'}})
      ])
    );
  };

  const renderEnemy = (en) => {
    if (en.type === 'enderman') return renderEnderman(en);
    if (en.type === 'dragon') return renderDragon(en);
    return renderVillager(en);
  };

  const renderCell = (cell, x, y) => {
    const isW = cell === WALL;
    const ch = [];
    
    if (cell === DOT) {
      ch.push(h('div',{key:'d',style:{
        width:14,height:14,
        background:'radial-gradient(circle at 30% 30%,#a0ffc0,#60d888,#30a858)',
        borderRadius:'50%',
        boxShadow:'0 3px 10px rgba(80,200,120,0.8),inset 3px 3px 4px rgba(255,255,255,0.7)',
        animation:'bobUp 1.5s ease-in-out infinite'
      }}));
    }
    if (cell === POWER) {
      ch.push(h('div',{key:'p',style:{
        width:24,height:24,
        background:'radial-gradient(circle at 30% 30%,#ffffc0,#ffd700,#daa520)',
        borderRadius:'50%',
        boxShadow:'0 4px 18px rgba(255,215,0,1),inset 4px 4px 6px rgba(255,255,255,0.8)',
        animation:'pulse 0.5s ease-in-out infinite'
      }}));
    }
    
    return h('div',{key:`${x}-${y}`,style:{
      position:'absolute',
      left: x * CELL,
      top: y * CELL,
      width: CELL,
      height: CELL,
      background: isW 
        ? 'linear-gradient(145deg,#5a9a6a,#4a8a5a,#3a7a4a,#2a6a3a)' 
        : 'linear-gradient(145deg,#5a3828,#4a2818,#3a1808)',
      boxShadow: isW 
        ? 'inset 4px 4px 3px rgba(150,220,150,0.4),inset -3px -3px 3px rgba(0,50,0,0.4),2px 2px 4px rgba(0,0,0,0.5)' 
        : 'inset 2px 2px 2px rgba(100,60,40,0.3),inset -2px -2px 2px rgba(0,0,0,0.4)',
      display:'flex',
      alignItems:'center',
      justifyContent:'center',
      borderRadius: isW ? 4 : 0
    }},ch);
  };

  const CtrlBtn = ({dir, sym, sz=60}) => h('button',{
    onTouchStart:e=>{e.preventDefault();e.stopPropagation();handleDir(dir)},
    onMouseDown:e=>{e.preventDefault();handleDir(dir)},
    style:{width:sz,height:sz,fontSize:sz*0.4,fontFamily:"'Press Start 2P',monospace",background:'linear-gradient(180deg,#7aba81,#5a9a61,#4a8a51)',border:'4px outset #9aca91',borderRadius:14,color:'#fff',textShadow:'2px 2px 0 #2a5a25',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',touchAction:'manipulation',userSelect:'none',outline:'none',opacity:waitingToStart?0.5:1,boxShadow:'3px 5px 10px rgba(0,0,0,0.6),inset 2px 2px 3px rgba(255,255,255,0.4)'}
  },sym);

  const LvlBtn = ({lv,sel,onClick}) => h('button',{onClick,style:{fontFamily:"'Press Start 2P',monospace",fontSize:10,width:34,height:34,background:sel?'linear-gradient(180deg,#70e898,#50c878,#40b868)':'linear-gradient(180deg,#8b92a0,#6b7280,#5b6270)',border:sel?'3px solid #30a858':'3px solid #4b5260',borderRadius:8,color:'#fff',cursor:'pointer',boxShadow:'2px 3px 6px rgba(0,0,0,0.5)'}},lv);

  const timeLimit = TIME_LIMITS[currentLevel + 1] || 120;
  const timeRemaining = Math.max(0, timeLimit - levelTime);
  const formatTime = (s) => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;

  return h('div',{onTouchStart:handleTouchStart,onTouchMove:handleTouchMove,onTouchEnd:handleTouchEnd,style:{minHeight:'100vh',background:'linear-gradient(180deg,#0a0515 0%,#1a0a2a 40%,#0d0d1a 100%)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'flex-start',padding:'4px 8px',fontFamily:"'Press Start 2P',monospace",overflow:'hidden',touchAction:'none'}},[
    // Modals
    showRules&&h('div',{key:'rules',style:{position:'fixed',inset:0,background:'rgba(0,0,0,0.97)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000,padding:12}},h('div',{style:{background:'linear-gradient(180deg,#3d2a4d,#2d1a3d)',border:'4px solid #50c878',borderRadius:16,padding:16,maxWidth:460,maxHeight:'85vh',overflow:'auto'}},[h('h2',{key:'t',style:{fontSize:11,color:'#50c878',marginBottom:10,textAlign:'center'}},'üìú HOW TO PLAY'),h('div',{key:'c',style:{fontSize:6,color:'#fff',lineHeight:2.2}},[h('p',{key:'1'},'üéØ Collect all EMERALDS!'),h('p',{key:'2',style:{color:'#ffd700',marginTop:4}},'üçé Golden Apple = POWER MODE!'),h('p',{key:'3'},'üì± SWIPE anywhere to move!'),h('p',{key:'4',style:{color:'#4ee4fc',marginTop:4}},'‚è±Ô∏è TIME BONUS: Up to 2 min! Faster = more points!'),h('p',{key:'5',style:{color:'#ff6b6b',marginTop:4}},'ENEMIES:'),h('p',{key:'6'},'üë§ VILLAGER (Brown) üü™ ENDERMAN (Black)'),h('p',{key:'7'},'üêâ DRAGON (Purple with wings!)'),h('p',{key:'8',style:{marginTop:4}},'üèÜ Start at L1 for max score!')]),h('button',{key:'b',onClick:()=>setShowRules(false),style:{display:'block',margin:'10px auto 0',fontSize:9,padding:'8px 16px',background:'linear-gradient(180deg,#50c878,#40b868)',border:'3px solid #30a858',borderRadius:8,color:'#fff',cursor:'pointer'}},'GOT IT!')])),

    showLeaderboard&&h('div',{key:'lb',style:{position:'fixed',inset:0,background:'rgba(0,0,0,0.97)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000,padding:12}},h('div',{style:{background:'linear-gradient(180deg,#3d2a4d,#2d1a3d)',border:'4px solid #ffd700',borderRadius:16,padding:16,minWidth:280}},[h('h2',{key:'t',style:{fontSize:9,color:'#ffd700',marginBottom:10,textAlign:'center'}},'üèÜ TOP 10'),leaderboard.length===0?h('p',{key:'e',style:{fontSize:7,color:'#888',textAlign:'center',padding:10}},'No scores yet!'):h('div',{key:'l',style:{marginBottom:10}},leaderboard.map((e,i)=>h('div',{key:i,style:{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'3px 6px',background:i===0?'rgba(255,215,0,0.25)':i===1?'rgba(192,192,192,0.2)':i===2?'rgba(205,127,50,0.2)':'transparent',borderRadius:4,marginBottom:2}},[h('span',{key:'n',style:{fontSize:6,color:i<3?'#ffd700':'#fff'}},`${i+1}. ${e.name}`),h('span',{key:'s',style:{fontSize:6,color:'#50c878'}},e.score),e.start&&h('span',{key:'l',style:{fontSize:5,color:'#888'}},`L${e.start}`)]))),h('button',{key:'b',onClick:()=>setShowLeaderboard(false),style:{display:'block',margin:'0 auto',fontSize:9,padding:'6px 14px',background:'linear-gradient(180deg,#6b7280,#5b6270)',border:'3px solid #4b5260',borderRadius:8,color:'#fff',cursor:'pointer'}},'CLOSE')])),

    showNameEntry&&h('div',{key:'ne',style:{position:'fixed',inset:0,background:'rgba(0,0,0,0.97)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000,padding:12}},h('div',{style:{background:'linear-gradient(180deg,#3d2a4d,#2d1a3d)',border:'4px solid #50c878',borderRadius:16,padding:16,textAlign:'center'}},[h('h2',{key:'t',style:{fontSize:10,color:'#ffd700',marginBottom:4}},'üéâ HIGH SCORE!'),h('p',{key:'s',style:{fontSize:13,color:'#50c878',marginBottom:10}},`${pendingScore}`),h('input',{key:'i',ref:nameInput,type:'text',value:playerName,onChange:e=>setPlayerName(e.target.value.slice(0,12)),onKeyDown:e=>{if(e.key==='Enter')saveToLeaderboard(playerName,pendingScore)},placeholder:'Your name',maxLength:12,style:{fontFamily:"'Press Start 2P',monospace",fontSize:9,padding:'6px 10px',background:'#1a0a1a',border:'3px solid #50c878',borderRadius:8,color:'#fff',textAlign:'center',width:150,marginBottom:10,outline:'none'}}),h('br',{key:'br'}),h('button',{key:'b',onClick:()=>saveToLeaderboard(playerName,pendingScore),style:{fontSize:9,padding:'6px 16px',background:'linear-gradient(180deg,#50c878,#40b868)',border:'3px solid #30a858',borderRadius:8,color:'#fff',cursor:'pointer'}},'SAVE')])),

    // Header
    h('div',{key:'hdr',style:{display:'flex',alignItems:'center',gap:5,marginBottom:2,flexWrap:'wrap',justifyContent:'center'}},[
      h('div',{key:'t',style:{background:'linear-gradient(180deg,#4d6055,#3d5045,#2d4035)',border:'3px solid #2d3035',borderRadius:8,padding:'3px 8px',boxShadow:'3px 4px 8px rgba(0,0,0,0.6)'}},h('h1',{style:{fontSize:9,color:'#50c878',margin:0}},'‚õèÔ∏è MINE MUNCHER 3D')),
      h('div',{key:'sc',style:{display:'flex',gap:3}},[
        h('div',{key:'s1',style:{background:'linear-gradient(180deg,#5d4847,#4d3837)',border:'2px solid #3d2827',borderRadius:5,padding:'2px 5px'}},h('span',{style:{fontSize:6,color:'#50c878'}},`${score}`)),
        h('div',{key:'s2',style:{background:'linear-gradient(180deg,#5d4847,#4d3837)',border:'2px solid #3d2827',borderRadius:5,padding:'2px 5px'}},h('span',{style:{fontSize:6,color:'#ff6b6b'}},'‚ù§Ô∏è'.repeat(lives))),
        h('div',{key:'s3',style:{background:'linear-gradient(180deg,#5d4847,#4d3837)',border:'2px solid #3d2827',borderRadius:5,padding:'2px 5px'}},h('span',{style:{fontSize:6,color:'#4ee4fc'}},`L${currentLevel+1}`)),
        gameStarted&&!gameOver&&!waitingToStart&&h('div',{key:'tm',style:{background:timeRemaining<20?'linear-gradient(180deg,#8d3030,#6d2020)':'linear-gradient(180deg,#3d5847,#2d4837)',border:'2px solid #2d3827',borderRadius:5,padding:'2px 5px'}},h('span',{style:{fontSize:6,color:timeRemaining<20?'#ff8888':'#88ff88'}},`‚è±${formatTime(timeRemaining)}`))
      ]),
      h('div',{key:'btns',style:{display:'flex',gap:3}},[
        h('button',{key:'r',onClick:()=>setShowRules(true),style:{fontSize:7,padding:'4px 6px',background:'linear-gradient(180deg,#6b7290,#5b6280)',border:'2px solid #4b5270',borderRadius:5,color:'#fff',cursor:'pointer'}},'üìú'),
        h('button',{key:'l',onClick:()=>setShowLeaderboard(true),style:{fontSize:7,padding:'4px 6px',background:'linear-gradient(180deg,#6b7290,#5b6280)',border:'2px solid #4b5270',borderRadius:5,color:'#fff',cursor:'pointer'}},'üèÜ')
      ])
    ]),

    h('button',{key:'snd',className:`sound-btn ${soundOn?'on':'off'}`,onClick:toggleSound},soundOn?'üîä SOUND ON':'üîá SOUND OFF'),

    powerMode&&h('div',{key:'pm',style:{background:'linear-gradient(180deg,#ffee00,#ffcc00)',border:'3px solid #ddaa00',borderRadius:8,padding:'2px 10px',marginBottom:1,animation:'pulse 0.3s ease-in-out infinite alternate',boxShadow:'0 0 25px rgba(255,200,0,0.8)'}},h('span',{style:{fontSize:7,color:'#000',fontWeight:'bold'}},'‚ö° POWER MODE! ‚ö°')),

    // Game board (FLAT view - no rotation)
    h('div',{key:'ga',style:{display:'flex',flexDirection:'column',alignItems:'center'}},[
      h('div',{key:'bd',style:{
        position:'relative',
        width: MAP_W * CELL,
        height: MAP_H * CELL,
        border:'5px solid #5a9a6a',
        borderRadius:8,
        boxShadow:'0 8px 30px rgba(0,0,0,0.8),0 0 30px rgba(90,150,100,0.3)',
        overflow:'visible',
        background:'linear-gradient(180deg,#2a1a10,#1a0a08)'
      }},[
        ...gameMap.flatMap((r,y)=>r.map((c,x)=>renderCell(c,x,y))),
        ...enemies.map(e=>renderEnemy(e)),
        gameStarted&&!gameOver&&renderSteve(),

        !gameStarted&&h('div',{key:'st',style:{position:'absolute',inset:0,background:'rgba(0,0,0,0.95)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:5,padding:10,borderRadius:6}},[
          h('div',{key:'t',style:{fontSize:14,color:'#50c878',textShadow:'3px 3px 0 #000'}},'MINE MUNCHER 3D'),
          h('div',{key:'h1',style:{fontSize:6,color:'#ffd700',marginTop:2}},'üéµ Tap SOUND ON for upbeat music!'),
          h('div',{key:'h2',style:{fontSize:5,color:'#aaa'}},'üì± Swipe to control! ‚è±Ô∏è 2 min time bonus!'),
          h('div',{key:'l',style:{fontSize:6,color:'#aaa',marginTop:3}},'Select Starting Level'),
          h('div',{key:'lvs',style:{display:'flex',gap:2,flexWrap:'wrap',justifyContent:'center',maxWidth:260}},[1,2,3,4,5,6,7,8,9,10,11,12].map(l=>h(LvlBtn,{key:l,lv:l,sel:selectedLevel===l,onClick:()=>setSelectedLevel(l)}))),
          h('div',{key:'h',style:{fontSize:4,color:'#666',marginTop:2}},'1-2=Super Easy | 3-4=Easy | 5-8=Med | 9-12=Hard'),
          h('button',{key:'b',onClick:()=>startGame(selectedLevel),style:{fontSize:10,padding:'8px 18px',background:'linear-gradient(180deg,#50c878,#40b868)',border:'3px solid #30a858',borderRadius:8,color:'#fff',cursor:'pointer',marginTop:3,boxShadow:'3px 4px 8px rgba(0,0,0,0.6)'}},'‚ñ∂ START')
        ]),

        gameStarted&&!gameOver&&waitingToStart&&h('div',{key:'wt',style:{position:'absolute',inset:0,background:'rgba(0,0,0,0.92)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:6,borderRadius:6}},[
          showDeath&&h('div',{key:'dm',style:{fontSize:9,color:'#ff6b6b',textShadow:'2px 2px 0 #000',animation:'deathFlash 0.5s ease-in-out 3',marginBottom:3}},deathMsg),
          h('div',{key:'t',style:{fontSize:9,color:'#ffd700',textShadow:'2px 2px 0 #000'}},showDeath?`Lives: ${'‚ù§Ô∏è'.repeat(lives)}`:`LEVEL ${currentLevel+1}`),
          h('div',{key:'tm',style:{fontSize:7,color:'#4ee4fc'}},`‚è±Ô∏è Time limit: ${formatTime(TIME_LIMITS[currentLevel+1])}`),
          h('div',{key:'h',style:{fontSize:7,color:'#aaa'}},showDeath?'Swipe or tap GO!':'Get Ready!'),
          h('button',{key:'b',onClick:startRound,style:{fontSize:11,padding:'8px 20px',background:'linear-gradient(180deg,#50c878,#40b868)',border:'3px solid #30a858',borderRadius:8,color:'#fff',cursor:'pointer',boxShadow:'3px 4px 8px rgba(0,0,0,0.6)'}},'‚ñ∂ GO!')
        ]),

        gameOver&&!showNameEntry&&h('div',{key:'go',style:{position:'absolute',inset:0,background:'rgba(0,0,0,0.95)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:5,borderRadius:6}},[
          h('div',{key:'t',style:{fontSize:12,color:lives>0?'#50c878':'#ff6b6b',textShadow:'2px 2px 0 #000'}},lives>0?'üèÜ YOU WIN! üèÜ':'üíÄ GAME OVER'),
          h('div',{key:'s',style:{fontSize:10,color:'#ffd700'}},`Score: ${score}`),
          h('div',{key:'l',style:{fontSize:6,color:'#aaa',marginTop:3}},'Play Again?'),
          h('div',{key:'lvs',style:{display:'flex',gap:2,flexWrap:'wrap',justifyContent:'center',maxWidth:260}},[1,2,3,4,5,6,7,8,9,10,11,12].map(l=>h(LvlBtn,{key:l,lv:l,sel:selectedLevel===l,onClick:()=>setSelectedLevel(l)}))),
          h('button',{key:'b',onClick:()=>startGame(selectedLevel),style:{fontSize:9,padding:'6px 16px',background:'linear-gradient(180deg,#50c878,#40b868)',border:'3px solid #30a858',borderRadius:8,color:'#fff',cursor:'pointer',marginTop:3}},lives>0?'PLAY AGAIN':'RETRY')
        ]),

        isPaused&&!gameOver&&h('div',{key:'pa',style:{position:'absolute',inset:0,background:'rgba(0,0,0,0.92)',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:6,borderRadius:6}},[
          h('div',{key:'t',style:{fontSize:13,color:'#ffd700',textShadow:'2px 2px 0 #000'}},'PAUSED'),
          h('div',{key:'h',style:{fontSize:6,color:'#aaa'}},'Tap RESUME')
        ])
      ]),

      h('div',{key:'ctrl',style:{display:'flex',justifyContent:'space-between',width:MAP_W*CELL,marginTop:6,paddingLeft:2,paddingRight:2}},[
        h('div',{key:'lf',style:{display:'flex',gap:5}},[h(CtrlBtn,{key:'l',dir:{x:-1,y:0},sym:'‚óÄ'}),h(CtrlBtn,{key:'r',dir:{x:1,y:0},sym:'‚ñ∂'})]),
        gameStarted&&!gameOver&&!waitingToStart&&h('button',{key:'pa',onClick:()=>setIsPaused(p=>!p),style:{fontSize:7,padding:'5px 10px',background:'linear-gradient(180deg,#6b7290,#5b6280)',border:'2px solid #4b5270',borderRadius:6,color:'#fff',cursor:'pointer',alignSelf:'center',boxShadow:'2px 3px 5px rgba(0,0,0,0.5)'}},isPaused?'RESUME':'PAUSE'),
        h('div',{key:'rt',style:{display:'flex',gap:5}},[h(CtrlBtn,{key:'u',dir:{x:0,y:-1},sym:'‚ñ≤'}),h(CtrlBtn,{key:'d',dir:{x:0,y:1},sym:'‚ñº'})])
      ])
    ])
  ]);
}

ReactDOM.createRoot(document.getElementById('root')).render(h(Game));
if('serviceWorker'in navigator)window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));
  </script>
</body>
</html>
